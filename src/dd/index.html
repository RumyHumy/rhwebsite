<!DOCTYPE html>
<html>
<head>
	<title>Pyodide in Web Worker</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=2.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/theme/monokai.min.css">
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/python/python.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/keymap/vim.min.js"></script>
</head>
<body>
	<button id="toggle-vim">Vim</button>
	<textarea id="editor">print("Hello, Python!")</textarea>
	<button id="run">Run</button>
	<div id="output"></div>
</body>
<script>

// E D I T O R

var editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
    mode:  "python",
    theme: "monokai",
    lineNumbers: true,
    tabSize: 4,
	indentUnit: 4,
	indentWithTabs: true,
    keyMap: "default"
});

var toggleVim = document.getElementById("toggle-vim")
toggleVim.addEventListener("click", function() {
	if (editor.getOption("keyMap") === "vim") {
		editor.setOption("keyMap", "default");
		toggleVim.textContent = "Vim";
	} else {
		editor.setOption("keyMap", "vim");
		toggleVim.textContent = "Default";
	}
});

// C O N S O L E

const outputElement = document.getElementById('output');

const worker = new Worker("/dd/worker.js");

worker.onmessage = (event) => {
	const { type, data } = event.data;
	switch (type) {
	case 'loaded':
		alert("Pyodide loaded!");
		break;
	case 'print':
		outputElement.appendChild(document.createTextNode(data));
		outputElement.appendChild(document.createElement("br"));
		break;
	case 'result':
		alert("RES");
		outputElement.appendChild(document.createTextNode("RESULT: "+data));
		outputElement.appendChild(document.createElement("br"));
		break;
	case 'error':
		outputElement.appendChild(document.createTextNode("ERROR: "+data));
		outputElement.appendChild(document.createElement("br"));
		break;
	}
};

var runButton = document.getElementById("run");
var codeTextarea = document.getElementById("editor");
function runCode() {
	outputElement.innerHTML = "";
	worker.postMessage({ code: editor.getValue() });
}
runButton.addEventListener("click", runCode);

// H O T K E Y S

document.addEventListener('keydown', function(event) {
	if ((event.ctrlKey || event.metaKey) && event.key === 's') {
		event.preventDefault();
	}
	if (event.key === 'F9') {
		runCode();
	}
});
</script>
</html>

